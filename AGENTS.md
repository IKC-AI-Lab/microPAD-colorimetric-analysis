# Repository Guidelines

## MATLAB-Python Architecture
- **MATLAB scripts** (`matlab_scripts/`): Data processing pipeline (stages 1→2→3, augmentation, feature extraction). Should NOT contain AI training logic (no YOLO label export, no model-specific code).
- **Python scripts** (`python_scripts/`): AI model training/inference (`prepare_yolo_dataset.py`, `train_yolo.py`, `detect_quads.py`). Reads MATLAB coordinates, generates training labels, provides inference helpers.
- **AI models**: YOLOv11-pose for keypoint detection (4 corners per concentration zone). Two configurations:
  - Desktop: yolo11s-pose @ 1280×1280 (`models/yolo11s-micropad-pose-1280.pt`)
  - Mobile: yolo11n-pose @ 640×640 (`models/yolo11n-micropad-pose-640.pt`)
- **Communication**: MATLAB calls Python via subprocess (`detect_quads.py` for inference). Python reads MATLAB `coordinates.txt` for label generation. No direct API coupling.
- **Principle**: Separation of concerns - MATLAB for data, Python for AI. Changes to AI training format should not require MATLAB modifications.

## Project Structure & Module Organization
- `matlab_scripts/`: Main MATLAB pipeline scripts (`cut_micropads.m`, `cut_elliptical_regions.m`, `extract_features.m`, `augment_dataset.m`) plus `helper_scripts/` utilities.
- `python_scripts/`: Python AI training/inference scripts (`prepare_yolo_dataset.py`, `train_yolo.py`, `detect_quads.py`).
- Stage folders (sequential I/O): `1_dataset/` -> `2_micropads/` -> `3_elliptical_regions/` -> `4_extract_features/`.
- Augmented data: `augmented_1_dataset/`, `augmented_2_micropads/`, `augmented_3_elliptical_regions/`.
- YOLO labels: Generated by Python scripts from MATLAB coordinates in `augmented_1_dataset/{phone}/labels/`.
- Image assets and raw datasets are intentionally ignored by Git (see `.gitignore`).

### Helper Scripts (`matlab_scripts/helper_scripts/`)

Modular utility functions organized by functionality. Each returns a struct of function handles.

| Script | Purpose | Used By |
|--------|---------|---------|
| `geometry_transform.m` | Geometry + homography operations (quad/ellipse transforms, projective math) | cut_micropads, augment_dataset |
| `feature_pipeline.m` | Feature registry + output (definitions, presets, Excel export, train/test split) | extract_features |
| `augmentation_synthesis.m` | Synthetic data generation (backgrounds, distractors, artifacts) | augment_dataset |
| `coordinate_io.m` | Coordinate file I/O (quad/ellipse formats) | cut_micropads, extract_features |
| `image_io.m` | Image loading with EXIF handling | cut_micropads, augment_dataset, extract_features |
| `mask_utils.m` | Quad/ellipse mask creation with caching | cut_micropads, extract_features |
| `path_utils.m` | Path resolution and folder operations | all main scripts |
| `color_analysis.m` | Color space conversions, paper detection | extract_features |
| `yolo_integration.m` | YOLO model inference via Python subprocess | cut_micropads |
| `micropad_ui.m` | GUI components for cut_micropads | cut_micropads |
| `file_io_manager.m` | File operations and atomic writes | cut_micropads, augment_dataset |

**Standalone utilities (not module pattern):**
- `preview_overlays.m` - Visualize quad overlays on images
- `preview_augmented_overlays.m` - Visualize augmented data results
- `extract_images_from_coordinates.m` - Extract image patches from coordinates

## Experimental Design
- **MicroPAD structure**: Each paper strip has 7 test zones (concentrations), each with 3 elliptical measurement regions.
- **Final design**: The 3 regions per zone will measure different chemicals (urea, creatinine, lactate).
- **Training phase**: All 3 regions contain the same chemical at the same concentration, yielding 3 replicate measurements per concentration level. This allows separate datasets for training ML models for each chemical.
- **File naming**: Stage 4 patches use `{base}_con{N}_rep{M}.{ext}` where `rep{M}` (M = 0, 1, 2) represents the 3 replicates.

## File Formats
- **Stage 2 coordinates.txt:** `image concentration x1 y1 x2 y2 x3 y3 x4 y4 rotation`
- **Stage 3 coordinates.txt:** `image concentration replicate x y semiMajorAxis semiMinorAxis rotationAngle`
- **YOLO labels:** `class_id x1 y1 vis1 x2 y2 vis2 x3 y3 vis3 x4 y4 vis4` (normalized, clockwise from top-left)

## Geometry Constraints
- Ellipse: `semiMajorAxis >= semiMinorAxis` (swap and rotate 90° if needed)
- Quad: clockwise vertex order from top-left

## Build, Test, and Development Commands
- Run a stage (MATLAB): `matlab -batch "addpath('matlab_scripts'); cut_micropads;"`
- Typical flow: `cut_micropads('numSquares',7)`, `cut_elliptical_regions`, `extract_features('preset','robust','chemical','lactate')`.
- Augmentation: `matlab -batch "addpath('matlab_scripts'); augment_dataset('numAugmentations',5);"`
- Prepare YOLO dataset: `python python_scripts/prepare_yolo_dataset.py`
- Train YOLO (desktop): `python python_scripts/train_yolo.py` (yolo11s-pose @ 1280px)
- Train YOLO (mobile): `python python_scripts/train_yolo.py --mobile` (yolo11n-pose @ 640px)
- Validate YOLO: `python python_scripts/train_yolo.py --validate --weights training_runs/yolo11s_pose_1280/weights/best.pt`
- Tests (if added): `matlab -batch "runtests('matlab_scripts')"`
- Code analysis: `matlab -batch "checkcode('matlab_scripts/script_name.m')"` (checks for unused variables, best practice violations, performance warnings)
Notes: Run from repo root or `matlab_scripts/`. Octave is not supported due to GUI/homography/Excel I/O.

## Coding Style & Naming Conventions
- MATLAB, 4-space indent, one public function per file. Use snake_case for files and functions (e.g., `extract_features.m`).
- Prefer name-value pairs for configuration; validate with `inputParser` or `arguments` blocks.
- Keep stage independence: each script reads `N_*` and writes `(N+1)_*`. Do not hardcode absolute paths.
- Variable names: descriptive nouns; Functions: verb phrases; Constants: ALL_CAPS.

### Helper Script Organization
When adding new MATLAB functions:
- Add to an existing helper script in `matlab_scripts/helper_scripts/` if the function belongs to an existing functionality class
- Create a new helper script only if it represents a distinct functionality class not covered by existing helpers
- Follow the module pattern: `function module = module_name()` returning a struct of function handles

## Testing Guidelines
- No formal suite yet. For changes, run a small subset per phone model and verify outputs and `coordinates.txt` integrity.
- If you add tests, place `test_*.m` under `matlab_scripts/tests/` using `matlab.unittest`; run with `runtests`.

## Commit & Pull Request Guidelines
- Use concise, imperative messages; Conventional Commits encouraged: `feat:`, `fix:`, `refactor:`, `docs:`.
- PRs should include: summary, affected stage(s), sample console output, and tiny before/after crops as attachments (do not commit images; use GitHub uploads). Link issues.
- Keep changes scoped; avoid reformatting large files. Do not commit raw datasets or generated images (they're ignored by default).
 - No AI/agent attribution: never add "Co-authored-by:" lines for Codex/AI, or phrases like "Generated with Codex" (or similar) in commit messages or files.
 - Preserve human authorship: do not inject bot signatures, agent headers, or metadata in commits; keep commit authors and footers human-only unless explicitly requested.

## Security & Configuration Tips
- `coordinates.txt` is written atomically; avoid manual edits. If corrupted, delete and rerun the stage.
- Ensure sufficient memory for `extract_features`; reduce batch size via `extract_features('batchSize',N)` if needed.
- `augment_dataset.m` is optimized for performance. See `documents/AUGMENT_OPTIMIZATION_REPORT.md` for current metrics and details.

## Common Issues
- **Path resolution:** Run from `matlab_scripts/` or project root
- **EXIF rotation:** Re-run GUI to update rotation in coordinates.txt
- **Corrupt coordinates:** Delete file and regenerate
- **Memory errors:** Use `extract_features('batchSize', 5)`

## Agent Execution Guidelines
- **Ask questions if stuck**: Do not add fallback algorithms instead; clarify requirements first
- **Never create new MATLAB scripts**: Only create new scripts when explicitly requested by the user
- **Fix root causes, not symptoms**: Address the underlying issue, not surface-level workarounds
- **Keep code simple and direct**: Minimal complexity for the current task
- **No backward compatibility code**: Project is in active development and NOT production-ready until complete; do not add migration logic, compatibility shims, or handling for "old versions"; use current formats exclusively and error out cleanly on invalid data
- No workarounds or fallbacks: implement direct solutions aligned with project constraints; do not add compatibility shims, alternative code paths, or temporary hacks
- Avoid overengineering and verbosity: keep changes minimal, focused, and idiomatic; do not add redundant layers, unused abstractions, or repetitive code
- Best practices first: follow all Coding Style & Naming Conventions above (snake_case, one public function per file, 4-space indent, name-value pairs, and validate with `inputParser`/`arguments`)
- Preserve stage independence and paths: read from `N_*`, write to `(N+1)_*`, and never hardcode absolute paths or alter the folder structure
- Do not add speculative features: no Octave fallbacks, GUI substitutes, optional modes, or extra outputs beyond the defined pipeline stages
- Minimize dependencies: do not introduce new toolboxes or third-party code unless explicitly requested; prefer MATLAB built-ins
- Fail fast over silent hacks: when inputs, data, or preconditions are missing, stop and request guidance instead of implementing workaround logic
- Keep interfaces stable: maintain filenames, data formats, and atomic writes (e.g., `coordinates.txt`) without unrequested changes
- Tests are minimal and targeted: if adding tests, place them under `matlab_scripts/tests/` using `matlab.unittest`; avoid placeholder or boilerplate tests
- Documentation changes are scoped: update only relevant sections and avoid broad reformatting unrelated to the task

## Comments & Documentation
- Keep descriptive and concise. Do not include code history, opinions, or obvious deductions.
